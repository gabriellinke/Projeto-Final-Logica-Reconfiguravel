/******************************************************************************
* Copyright (c) 2006 Altera Corporation, San Jose, California, USA.           *
* All rights reserved. All use of this software and documentation is          *
* subject to the License Agreement located at the end of this file below.     *
*******************************************************************************                                                                             *
* Date - October 24, 2006                                                     *
* Module - iniche_init.c                                                      *
*                                                                             *                                                                             *
******************************************************************************/

/******************************************************************************
 * NicheStack TCP/IP stack initialization and Operating System Start in main()
 * for Simple Socket Server (SSS) example. 
 * 
 * This example demonstrates the use of MicroC/OS-II running on NIOS II.       
 * In addition it is to serve as a good starting point for designs using       
 * MicroC/OS-II and Altera NicheStack TCP/IP Stack - NIOS II Edition.                                                                                           
 *      
 * Please refer to the Altera NicheStack Tutorial documentation for details on 
 * this software example, as well as details on how to configure the NicheStack
 * TCP/IP networking stack and MicroC/OS-II Real-Time Operating System.  
 */
  
#include <stdio.h>
#include <stdint.h>
#include <conio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>
#include <io.h>
#include <fcntl.h>
/* MicroC/OS-II definitions */
#include "../fir_bsp/HAL/inc/includes.h"

#include "../fir_bsp/system.h"

#include "dm9000a.h"

/* Simple Socket Server definitions */
#include "simple_socket_server.h"
#include "alt_error_handler.h"

/* Nichestack definitions */
#include "../fir_bsp/iniche/src/h/nios2/ipport.h"
#include "../fir_bsp/iniche/src/h/tcpport.h"
#include "../fir_bsp/iniche/src/h/libport.h"
#include "../fir_bsp/iniche/src/nios2/osport.h"
#include "basic_io.h"
#include "LCD.h"
#include "altera_avalon_pio_regs.h"
/* Definition of task stack for the initial task which will initialize the NicheStack
 * TCP/IP Stack and then initialize the rest of the Simple Socket Server example tasks. 
 */
OS_STK    SSSInitialTaskStk[TASK_STACKSIZE];

/* Declarations for creating a task with TK_NEWTASK.  
 * All tasks which use NicheStack (those that use sockets) must be created this way.
 * TK_OBJECT macro creates the static task object used by NicheStack during operation.
 * TK_ENTRY macro corresponds to the entry point, or defined function name, of the task.
 * inet_taskinfo is the structure used by TK_NEWTASK to create the task.
 */
TK_OBJECT(to_ssstask);
TK_ENTRY(SSSSimpleSocketServerTask);
void disp_7seg(int _duty_cycle, int _prescaler, int _timer, int _enable);
int binaryTodecimal (char num[]);
char *decimal_to_binary(int n);
int str_length( char str[]);

struct inet_taskinfo ssstask = {
      &to_ssstask,
      "simple socket server",
      SSSSimpleSocketServerTask,
      4,
      APP_STACK_SIZE,
};

/* SSSInitialTask will initialize the NicheStack
 * TCP/IP Stack and then initialize the rest of the Simple Socket Server example 
 * RTOS structures and tasks. 
 */
void SSSInitialTask(void *task_data)
{
  INT8U error_code;

  /*
   * Initialize Altera NicheStack TCP/IP Stack - Nios II Edition specific code.
   * NicheStack is initialized from a task, so that RTOS will have started, and
   * I/O drivers are available.  Two tasks are created:
   *    "Inet main"  task with priority 2
   *    "clock tick" task with priority 3
   */
  LCD_Line1();
  LCD_Show_Text("Adquirindo IP");
  LCD_Line2();
  LCD_Show_Text("via DHCP -- PWM");

//  alt_iniche_init();
//  netmain();

  /* Wait for the network stack to be ready before proceeding.
   * iniche_net_ready indicates that TCP/IP stack is ready, and IP address is obtained.
   */
//  while (!iniche_net_ready)
//    TK_SLEEP(1);

  /* Now that the stack is running, perform the application initialization steps */

  /* Application Specific Task Launching Code Block Begin */

  printf("\nSimple Socket Server starting up\n");


  LCD_Init();

  struct sockaddr_in sa;
  int res;
  int SocketFD;
  char buf[2000];
  char p1[32];
/*
  printf("Inicializacao\n");

  SocketFD = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
  printf("Socket criado\n");

  memset(&sa, 0, sizeof sa);
  sa.sin_family = AF_INET;
  sa.sin_port = htons(5000); // ALTERAR PORTA
  res = inet_pton(AF_INET, "192.168.0.210", &sa.sin_addr); //ALTERAR O IP

  if (connect(SocketFD, (struct sockaddr *)&sa, sizeof sa) == -1) {
	perror("connect failed");
	close(SocketFD);
	exit(EXIT_FAILURE);
  }
*/
  while (1){
/*
	  if (recv(SocketFD, buf, sizeof(buf), 0) < 0)  {
	  		perror("Error - Recv()");
	  		exit(EXIT_FAILURE);
	  } else {
	  		printf("Msg recebida: %s\n", buf);
	  		memcpy(p1, buf, 32 * sizeof(char));

	  		printf("MSG BIN: %s\n", buf);
	  }
*/
	  //int16_t vetor[] = {1638, 2488, 2350, 2251, 2209, 3544, 6114, 5132, 6436, 7221, 9719, 8887, 12331, 10590, 12069, 12814, 15082, 16735, 14742, 18205, 19186, 19818, 19029, 18573, 22093, 20068, 23453, 22344, 22302, 25341, 23101, 24413, 27481, 27550, 25386, 26694, 28945, 27971, 28815, 29434, 28659, 31704, 28898, 30550, 30259, 31593, 30979, 30928, 32295, 32767, 31661, 31998, 31910, 32767, 32767, 32767, 31930, 32557, 32209, 32138, 32468, 32405, 32767, 31831, 32727, 29945, 30914, 32490, 31195, 30064, 29290, 31054, 29819, 28736, 27035, 28539, 26734, 28094, 25973, 24457, 25426, 22972, 22955, 22156, 23077, 21033, 20375, 18728, 17867, 18648, 18106, 17685, 15943, 16551, 13239, 13678, 12819, 11867, 11634, 10364, 10442, 8200, 7177, 6794, 4997, 4357, 2403, 1755, 1169, -399, -239, -69 , -774, -1856, -4934, -3504, -5923, -6421, -6380, -7011, -10114, -11083, -10623, -11998, -12939, -12355, -12875, -15730, -15078, -16013, -17086, -17134, -20240, -21300, -19502, -21805, -20965, -24135, -23626, -24716, -25955, -24694, -27329, -27226, -27102, -26356, -28333, -29391, -27701, -29588, -30192, -29653, -31456, -30898, -32641, -32751, -32627, -30377, -31067, -32658, -31089, -31411, -32676, -31739, -31980, -31354, -31190, -32767, -32767, -32767, -32767, -32480, -32767, -30499, -30968, -31919, -30810, -30074, -32016, -29357, -31454, -30771, -29792};
	    int tamanho = sizeof(vetor) / sizeof(vetor[0]);

	    int16_t vetor[] = {32567, 32767, 32767, 32120, 31416, 32767, 30916, 32767, 32767, 32767, 31278, 31696, 31973, 32216, 31139, 28916, 28940, 28618, 27995, 28384, 28835, 27109, 27133, 25260, 24580, 25374, 23586, 22653, 23327, 24090, 21852, 21992, 22227, 20697, 19141, 20004, 17671, 16813, 15448, 14690, 13779, 13348, 12091, 12349, 12645, 9537, 8655, 9646, 6758, 6196, 6936, 3929, 4910, 1405, 2567, -211, 649 , -1135, -840, -3062, -4195, -3720, -4052, -7589, -5633, -9127, -7575, -10122, -11455, -11516, -13956, -12214, -15189, -14958, -15818, -16321, -17210, -17808, -17506, -18668, -21027, -20983, -22511, -22197, -24472, -23336, -25111, -26507, -24850, -26632, -28114, -28121, -27955, -29068, -28499, -28146, -29664, -31591, -31883, -31638, -30442, -30986, -31497, -32416, -31625, -31645, -32705, -32469, -31314, -32767, -32767, -32680, -32767, -32767, -32767, -32767, -31052, -32767, -32365, -32767, -32308, -32767, -32443, -31707, -29512, -29136, -28696, -29784, -28314, -27346, -27666, -27536, -28838, -26919, -24765, -25445, -26232, -23727, -25119, -23029, -22194, -22159, -21630, -19073, -21121, -18930, -17203, -18393, -17479, -14515, -14809, -13263, -12587, -11368, -13019, -10789, -10435, -10209, -6322, -7656, -7636, -6239, -3434, -2145, -3135, -1267, -535, 859 , 906 , 1800, 331 , 4183, 4107, 4667, 5123, 5246, 5820, 9333, 9481, 9734, 9701, 12949, 14017, 12799, 14432, 15667, 15238, 16649, 17148, 19114, 20471, 21159, 19274, 23053, 20525, 21231, 22213, 24112, 25579, 24955, 25358, 26419, 28521, 28258, 28277, 28814, 29977, 27868, 28604, 30099, 31890, 31849, 32426, 29985, 30107, 32683, 31558, 32767, 31860, 31440, 31228, 32767, 32347, 31400, 32767, 32271, 31602, 32767, 32767, 31067, 30596, 31777, 30359, 31163, 31757, 29660, 31639, 31792, 30437, 30356, 28525, 29335, 28499, 28012, 27942, 25316, 27450, 26269, 23403, 23660, 22708, 21497, 21460, 21781, 21447, 18701, 19050, 19227, 18920, 17881, 17472, 16836, 13809, 14202, 13524, 12488, 10345, 10630, 10350, 7970, 8126, 7806, 4851, 5717, 4886, 4119, 548 , -194, -517, -2090, -1083, -1345, -1909, -3535, -6797, -7510, -7747, -8093, -8736, -10596, -9497, -11177, -12341, -12479, -13344, -16297, -15715, -16517, -17769, -19623, -18152, -18230, -22048, -20453, -22301, -21004, -22793, -22728, -25262, -24092, -27148, -27547, -26816, -26142, -28322, -29314, -27504, -29555, -29140, -29351, -30056, -30192, -30554, -31351, -32767, -32525, -31221, -31181, -31374, -32677, -32767, -32767, -32487, -32767, -32767, -32308, -32767, -32767, -31283, -31248, -32767, -31677, -32767, -30122, -31232, -29354, -29489, -29437, -28750, -28461, -28493, -28948, -26952, -29030, -26331, -25522, -25956, -25026, -24854, -25070, -23608, -23198, -21654, -22847, -22168, -21728, -20701, -18470, -16778, -16134, -15270, -16708, -14012, -13005, -13548, -12267, -10757, -10733, -9901, -9039, -8874, -5665, -7463, -4992, -4209, -2143, -3357, -674, 9   , -180, -297, 168 , 687 , 2976, 2358, 5297, 6498, 7879, 5866, 8083, 8384, 10086, 10485, 11667, 12208, 12629, 14909, 16478, 17017, 17429, 16518, 20010, 19293, 20776, 20958, 22371, 22227, 22534, 23601, 23097, 25929, 26701, 24918, 25028, 28053, 27698, 26743, 29999, 29380, 28968, 30911, 29438, 29243, 30018, 29541, 30445, 32406, 32767, 30630, 31538, 32767, 32767, 31372, 31435, 31414, 32767, 32767, 32767, 32767, 30980, 32419, 31198, 32767, 32654, 31227, 29890, 31353, 32347, 30344, 31300, 30558, 30425, 28985, 28832, 28239, 26749, 26511, 27928, 24952, 24868, 26057, 25175, 22717, 24260, 21302, 23128, 19403, 21252, 19499, 17018, 18828, 16206, 14679, 16612, 14335, 14948, 12600, 13226, 12729, 11316, 10376, 9372, 6817, 6349, 4558, 5234, 5172, 2591, 2687, 2031, -255, -543, -2296, -1019, -5034, -4327, -6530, -5851, -8478, -7805, -8635, -10673, -10981, -13227, -13885, -12294, -13390, -14640, -14987, -16507, -16951, -19064, -19602, -18466, -20649, -22208, -21689, -23374, -24591, -23257, -26018, -23807, -24615, -27415, -27669, -27673, -27624, -29632, -30304, -29270, -29309, -28749, -30736, -31734, -29588, -31462, -32767, -31960, -31908, -32317, -32767, -32767, -31346, -31706, -32767, -31670, -32767, -32222, -31559, -32767, -32767, -32767, -31671, -31477, -31735, -29929, -29672, -32419, -30400, -29238, -28770, -27996, -28297, -30319, -28529, -28711, -28247, -26852, -27048, -24479, -23770, -23495, -23225, -21749, -21876, -22301, -21045, -21320, -19691, -18376, -17020, -17645, -14925, -14147, -16112, -14276, -12952, -13472, -11160, -9270, -10210, -8142, -9138, -5557, -5391, -5023, -4423, -4891, -2046, -1274, -2091, -110, 571 , 142 , 1321, 3422, 2183, 5903, 7170, 5550, 6551, 7422, 7583, 8896, 11399, 12946, 11768, 13970, 13161, 16123, 17536, 16129, 17832, 19651, 17946, 20761, 21754, 22422, 22019, 23806, 22540, 22615, 24920, 25257, 24939, 26730, 27833, 28739, 26516, 28909, 28491, 27831, 30374, 31367, 29832, 31059, 31721, 29904, 31980, 32767, 31833, 32767, 31468, 32755, 32642, 32767, 32767, 32767, 32767, 32674, 32767, 32767, 31412, 31103, 31936, 31792, 32767, 30840, 31344, 29495, 31433, 29737, 30950, 29531, 29756, 27461, 28794, 27636, 27248, 25640, 24838, 23872, 24232, 24141, 25106, 24099, 21442, 22168, 21160, 19392, 19207, 17713, 17902, 16661, 15628, 15502, 13097, 12553, 14367, 12045, 12611, 11188, 9664, 9286, 9047, 6659, 5588, 5551, 4768, 2460, 3234, 19  , -8  , -288, -1241, -1943, -2054, -3564, -5443, -6439, -7961, -8358, -8995, -8535, -9305, -13159, -12683, -13008, -15467, -16678, -16325, -16668, -18203, -18922, -18920, -18813, -19021, -22564, -20510, -24086, -21672, -25026, -25397, -24689, -25705, -26263, -27894, -27255, -29138, -29195, -28340, -29304, -30432, -30515, -31535, -29386, -30240, -31888, -30288, -32199, -32767, -32767, -32767, -32767, -31941, -32767, -32367, -32767, -31453, -32767, -32767, -32767, -31998, -32767, -31341, -32767, -31647, -30484, -30116, -30513, -29754, -30710, -31113, -28854, -28747, -28873, -27876, -28688, -25834, -26333, -27358, -24656, -24691, -23942, -23535, -23109, -23312, -21852, -21057, -19848, -18615, -20328, -17715, -16870, -15154, -14360, -15975, -14218, -14202, -11262, -12416, -10453, -8207, -10044, -7817, -8154, -4991, -6471, -4105, -1954, -2980, -2226, -588, -600, 162 , 1954, 3351, 2257, 3126, 4381, 4499, 6714, 7664, 8087, 10284, 10469, 9843, 10267, 13214, 14255, 14988, 15473, 15314, 16820, 17520, 19643, 18404, 21070, 20475, 20984, 21788, 22560, 21977, 24348, 24651, 24986, 25157, 26058, 27281, 27902, 29556, 28641, 27605, 30538, 31289, 30484, 29379, 29422, 32007, 32577, 31304, 32288, 32767, 32429, 32767, 32767, 32767, 32767, 32767, 32767, 32767, 32767, 32553, 32767, 32767, 32594, 32577, 32767, 30353, 31474, 30532, 31746, 30851, 28959, 29550, 29916, 27989, 28101, 29567, 26600, 26991, 26193, 24716, 25852, 24098, 25715, 24269, 21644, 23362, 22718, 21812, 19829, 19891, 17888, 18755, 17891, 16554, 15950, 13187, 13517, 11380, 10801, 11408, 9555, 9695, 9659, 8389, 7620, 5772, 4863, 5133, 3981, 2895, 1201, 1456, 520 , -3039, -3746, -3031, -5405, -4449, -6072, -7469, -7940, -8682, -11031, -11789, -12543, -12563, -12689, -12694, -15765, -16213, -16853, -18102, -17368, -20158, -19280, -19209, -21444, -23028, -22545, -22455, -23042, -25854, -26765, -24136, -27841, -27450, -26377, -28007, -28952, -28531, -28005, -30277, -28587, -29499, -31058, -29544, -29957, -32410, -32476, -32767, -32000, -31412, -31303, -32767, -31553, -31824, -32767, -32767, -32767, -31657, -32011, -32360, -31774, -32767, -30680, -31071, -32569, -30334, -31437, -31629, -29437, -31566, -29460, -27862, -28312, -27090, -28128, -28509, -26486, -24935, -26561, -24371, -23112, -25096, -21817, -20950, -22650, -19536, -21840, -18328, -19877, -19029, -17100, -18104, -14301, -16307, -15426, -14237, -13328, -11926, -12113, -8909, -7857, -6527, -6508, -6078, -5007, -4389, -3122, -1759, -587, -1258, 435 , -1328, 1421, 2607, 4183, 3032, 5208, 6573, 7397, 7982, 7655, 9590, 11244, 11119, 12251, 11652, 14553, 15876, 14406, 14543, 16218, 19197, 19405, 18770, 21580, 20522, 22307, 23013, 21457, 23037, 23725, 23237, 25047, 26928, 25350, 27169, 28356, 26391, 29524, 27620, 28798, 29084, 31768, 30154, 29236, 32273, 32154, 31644, 32767, 32192, 32747, 32767, 32767, 31267, 32767, 31539, 32767, 32767, 32767, 32006, 32767, 32337, 32592, 30927, 30737, 30401, 30729, 31863, 30990, 29474, 29860, 28640, 30000, 30320, 29947, 26597, 27799, 25587, 27977, 26802, 26533, 25111, 25807, 22725, 23891, 22823, 22427, 20764, 19292, 17978, 17356, 17162, 15962, 15241, 13949, 15157, 12432, 11690, 12677, 9574, 9025, 9680, 9930, 6720, 5953, 5480, 5768, 5255, 3680, 1829, 2264, 804 , -1736, -2854, -2469, -2459, -5140, -5842, -7651, -7124, -7604, -8987, -10721, -12321, -11273, -13650, -13138, -15080, -14466, -14964, -16989, -16420, -18720, -19896, -21114, -21723, -21002, -23398, -21594, -24488, -25341, -24276, -24916, -26885, -26301, -26283, -28551, -28297, -26762, -30379, -29059, -28714, -28717, -29146, -30896, -31939, -31155, -31286, -32767, -32358, -32767, -31019, -32421, -31733, -31303, -32258, -32510, -31771, -32767, -31225, -32767, -32767, -30821, -32767, -32767, -32402, -31700, -31537, -29779, -30242, -28834, -30411, -28060, -29814, -27197, -27256, -26148, -27666, -27411, -24735, -26658, -23493, -25565, -23626, -22827, -22441, -22759, -22536, -21481, -18028, -20048, -18476, -16186, -17623, -14102, -14922, -12640, -12786, -13694, -11195, -10950, -10623, -7239, -8271, -7860, -7343, -4073, -3817, -3551, -1486, -1488, -1456, -926, 1501, 2020, 3050, 3051, 3264, 4195, 4886, 7222, 6922, 8021, 8786, 9341, 9364, 10291, 14243, 13986, 14162, 14269, 15146, 18119, 17120, 17351, 20238, 20010, 22241, 22623, 23454, 23794, 22033, 23286, 25751, 25636, 25594, 25543, 26096, 28901, 28631, 29650, 29653, 29778, 29034, 31221, 28948, 30116, 31800, 30578, 32250, 32337, 31752, 32767, 32767, 31212, 32164, 32767, 32767, 32767, 32767, 31205, 32767, 32767, 32187, 32767, 32767, 32767, 32035, 31194, 29840, 29552, 29699, 30991, 29852, 30060, 27905, 28414, 27376, 28941, 26833, 27977, 26237, 26759, 26197, 22839, 23407, 21998, 22987, 21562, 21275, 20750, 18330, 17919, 17642, 17146, 15627, 15609, 13058, 13639, 12037, 11360, 10401, 8902, 10196, 10072, 7463, 7248, 4823, 3420, 3692, 4457, 1444, 2530, 1008, -1818, -258, -4021, -2155, -2854, -4631, -7146, -8093, -8754, -10456, -10828, -11436, -13154, -13998, -12158, -15400, -15853, -15883, -17700, -18984, -16808, -20390, -19812, -21525, -22154, -22739, -21119, -23938, -24010, -24610, -24022, -26972, -27043, -27244, -27920, -29397, -27383, -28390, -29310, -28866, -29389, -28995, -31642, -31829, -32294, -32767, -31765, -31849, -31264, -30975, -32513, -32767, -32662, -32749, -32325, -31490, -31332, -31767, -32767, -31823, -30753, -32767, -31778, -32028, -31695, -32624, -30646, -30364, -29263, -28707, -28954, -28551, -29323, -29068, -29186, -27243, -27167, -26908, -26905, -24962, -23201, -22372, -23719, -23698, -20823, -19439, -19913, -19368, -17760, -19387, -16952, -16535, -16937, -16115, -15011, -14594, -12063, -10845, -10717, -8780, -9637, -6804, -6093, -5252, -3483, -4711, -3658, -2654, -739, 1037, 548 , 684 , 588 , 2406, 1791, 2369, 5824, 6187, 5651, 8952, 9069, 10477, 11219, 11455, 12288, 13156, 13725, 15140, 14143, 16621, 16690, 18009, 18510, 18260, 18629, 21569, 22058, 21542, 22831, 22808, 25146, 23184, 26007, 27219, 24893, 25872, 29073, 27202, 29793, 27799, 30640, 29552, 31536, 31442, 30466, 31149, 31138, 32078, 30604, 32118, 32675, 32270, 32767, 32767, 32767, 32092, 32767, 32767, 32156, 32767, 31308, 32326, 32767, 31955, 31562, 31145, 30480, 29672, 29555, 29093, 31645, 29491, 31047, 29304, 30140, 27444, 29257, 27039, 27089, 24953, 24353, 26474, 25352, 22950, 24521, 21181, 22285, 19814, 18716, 20553, 17631, 16895, 16987, 17863, 16332, 13530, 12371, 11453, 13282, 11533, 10098, 10458, 9921, 6090, 5735, 5485, 5725, 3152, 3032, 794 , 2204, 1727, -872, -472, -3716, -3677, -4871, -4406, -5843, -6828, -7945, -9474, -10649, -11528, -11637, -12283, -12536, -13288, -16148, -15197, -18178, -18719, -18091, -20064, -20159, -20862, -21317, -21004, -21743, -22099, -25354, -24460, -25351, -25696, -27928, -28000, -26107, -27236, -27259, -29245, -30861, -28890, -30931, -30765, -30035, -31000, -32716, -32124, -32767, -31069, -32767, -32135, -30929, -32478, -31719, -32767, -32520, -32767, -31676, -32767, -31385, -31550, -30920, -32135, -32515, -32328, -32604, -30437, -31268, -29834, -30080, -29093, -29342, -27689, -30002, -27793, -27544, -28130, -26893, -25204, -24594, -23843, -24920, -23349, -22417, -23608, -20499, -22524, -19575, -21186, -19832, -19368, -15787, -16518, -14598, -15653, -13290, -13429};
	    int16_t readIO;
	    int i;
	    for (i = 0; i < tamanho; i++) {
	    	IOWR_16DIRECT(0, 0, vetor[i]);
	     	readIO = IORD_16DIRECT(0, 0);
	     	printf("%d\n", readIO);
	    }

	  msleep(300000);
  }
}

/* Main creates a single task, SSSInitialTask, and starts task scheduler.
 */

int main (int argc, char* argv[], char* envp[])
{
  
  INT8U error_code;

  DM9000A_INSTANCE( DM9000A_0, dm9000a_0 );
  DM9000A_INIT( DM9000A_0, dm9000a_0 );

  /* Clear the RTOS timer */
  OSTimeSet(0);

  /* SSSInitialTask will initialize the NicheStack
   * TCP/IP Stack and then initialize the rest of the Simple Socket Server example
   * RTOS structures and tasks.
   */
  error_code = OSTaskCreateExt(SSSInitialTask,
                             NULL,
                             (void *)&SSSInitialTaskStk[TASK_STACKSIZE],
                             SSS_INITIAL_TASK_PRIORITY,
                             SSS_INITIAL_TASK_PRIORITY,
                             SSSInitialTaskStk,
                             TASK_STACKSIZE,
                             NULL,
                             0);
  alt_uCOSIIErrorHandler(error_code, 0);

  /*
   * As with all MicroC/OS-II designs, once the initial thread(s) and
   * associated RTOS resources are declared, we start the RTOS. That's it!
   */
  OSStart();
  
  while(1); /* Correct Program Flow never gets here. */

  return -1;
}

int str_length( char str[])
{
   int i = 0;
   while (str[i] != '\0')
       i++;
   return i;
}

int binaryTodecimal (char num[])
{
    int i, deci_num, mul = 0;
    for ( deci_num = 0, i = str_length(num) - 1; i >= 0; --i, ++mul)
    {
            deci_num = deci_num + (num[i] - 48) * (1 << mul);
    }

    return deci_num;
 }

char *decimal_to_binary(int n)
{
  int c, d, t;
  char *p;

  t = 0;
  p = (char*)malloc(32+1);

  if (p == NULL)
    exit(EXIT_FAILURE);

  for (c = 31 ; c >= 0 ; c--)
  {
    d = n >> c;

    if (d & 1)
      *(p+t) = 1 + '0';
    else
      *(p+t) = 0 + '0';

    t++;
  }
  *(p+t) = '\0';

  return  p;
}


void disp_7seg(int _duty_cycle, int _prescaler, int _timer, int _enable){

	int disp1, disp2, disp3, disp4, disp5, disp6, disp7, disp8;

    disp1 = 0;
    disp2 = _duty_cycle;

    disp3 = 0;
    disp4 = _prescaler;

    disp5 = 0;
    disp6 = _timer;

    disp7 = 0;
    disp8 = _enable;

	IOWR_ALTERA_AVALON_PIO_DATA(SEG7_DISPLAY_BASE, ((disp1 << 28) + (disp2 << 24) + (disp3 << 20) + (disp4 << 16) + (disp5 << 12) + (disp6 << 8) + (disp7 << 4) + (disp8 << 0)));

}

/******************************************************************************
*                                                                             *
* License Agreement                                                           *
*                                                                             *
* Copyright (c) 2006 Altera Corporation, San Jose, California, USA.           *
* All rights reserved.                                                        *
*                                                                             *
* Permission is hereby granted, free of charge, to any person obtaining a     *
* copy of this software and associated documentation files (the "Software"),  *
* to deal in the Software without restriction, including without limitation   *
* the rights to use, copy, modify, merge, publish, distribute, sublicense,    *
* and/or sell copies of the Software, and to permit persons to whom the       *
* Software is furnished to do so, subject to the following conditions:        *
*                                                                             *
* The above copyright notice and this permission notice shall be included in  *
* all copies or substantial portions of the Software.                         *
*                                                                             *
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  *
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    *
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE *
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER      *
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING     *
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER         *
* DEALINGS IN THE SOFTWARE.                                                   *
*                                                                             *
* This agreement shall be governed in all respects by the laws of the State   *
* of California and by the laws of the United States of America.              *
* Altera does not recommend, suggest or require that this reference design    *
* file be used in conjunction or combination with any other product.          *
******************************************************************************/
